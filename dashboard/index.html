<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AI Telephony Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #1a202c;
      }
      
      .header-bar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: 1rem 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      }
      
      .header-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
      }
      
      .logo-section {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      
      .logo {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      }
      
      .logo svg {
        width: 28px;
        height: 28px;
        fill: white;
      }
      
      h1 {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .status-bar {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-left: auto;
        flex-wrap: wrap;
      }
      
      .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      
      .status-badge.success {
        background: #d4edda;
        color: #155724;
      }
      
      .status-badge.error {
        background: #f8d7da;
        color: #721c24;
      }
      
      .status-badge.muted {
        background: #e2e8f0;
        color: #64748b;
      }
      
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .controls {
        display: flex;
        gap: 0.5rem;
      }
      
      button {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: none;
        background: #667eea;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
      }
      
      button:hover {
        background: #5568d3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }
      
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
      }
      
      .card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        transition: all 0.3s;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      
      .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      
      .card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f7fafc;
      }
      
      .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      
      .card-icon svg {
        width: 20px;
        height: 20px;
        fill: white;
      }
      
      .card h2 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #2d3748;
        flex: 1;
      }
      
      .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f7fafc;
      }
      
      .metric-row:last-child {
        border-bottom: none;
      }
      
      .metric-label {
        font-size: 0.875rem;
        color: #64748b;
        font-weight: 500;
      }
      
      .metric-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a202c;
      }
      
      .metric-value.large {
        font-size: 2rem;
      }
      
      .pill {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        background: #e2e8f0;
        color: #475569;
        margin: 0.25rem;
      }
      
      .tag {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      
      .tag-emergency {
        background: #fee;
        color: #c00;
      }
      
      .tag-normal {
        background: #e3f2fd;
        color: #1565c0;
      }
      
      .empty-state {
        text-align: center;
        padding: 2rem;
        color: #94a3b8;
      }
      
      .empty-state svg {
        width: 64px;
        height: 64px;
        fill: #cbd5e1;
        margin-bottom: 1rem;
      }
      
      input[type="text"],
      input[type="password"],
      input[type="date"],
      select,
      textarea {
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        font-family: inherit;
        font-size: 0.875rem;
        transition: all 0.2s;
      }
      
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group {
        margin-bottom: 1rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
      }

      label small {
        font-weight: 600;
        color: #475569;
      }
      
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
      }
      
      .kpi-card {
        text-align: center;
        padding: 1rem;
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        border-radius: 12px;
      }
      
      .kpi-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 0.25rem;
      }
      
      .kpi-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
      }
      
      body.dark {
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        color: #e2e8f0;
      }
      
      body.dark .header-bar {
        background: rgba(26, 32, 44, 0.95);
        border-bottom-color: rgba(255, 255, 255, 0.1);
      }
      
      body.dark .card {
        background: #2d3748;
        border-color: rgba(255, 255, 255, 0.1);
      }
      
      body.dark .card h2 {
        color: #e2e8f0;
      }
      
      body.dark .metric-label {
        color: #a0aec0;
      }
      
      body.dark .metric-value {
        color: #e2e8f0;
      }
      
      body.dark input,
      body.dark select,
      body.dark textarea {
        background: #1a202c;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: #94a3b8;
      }
      
      .loading::after {
        content: "";
        width: 20px;
        height: 20px;
        border: 3px solid #e2e8f0;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 0.5rem;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
      }
      
      .feature-item {
        display: flex;
        align-items: start;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 8px;
      }
      
      body.dark .feature-item {
        background: #1a202c;
      }
      
      .feature-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      
      .feature-icon svg {
        width: 16px;
        height: 16px;
        fill: white;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(32px, 1fr));
        gap: 0.35rem;
      }

      .calendar-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.35rem 0.25rem;
        border-radius: 8px;
        border: none;
        background: #edf2f7;
        color: #1f2933;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .calendar-day:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);
      }

      .calendar-day-date {
        font-weight: 600;
        margin-bottom: 0.05rem;
      }

      .calendar-day-total {
        font-size: 0.7rem;
        opacity: 0.8;
      }

      .calendar-day-emergency {
        background: #fee2e2;
        color: #991b1b;
      }

      .calendar-day-maintenance {
        background: #ecfdf5;
        color: #047857;
      }

      .calendar-day-routine {
        background: #e0f2fe;
        color: #0369a1;
      }

      .calendar-day-new-client {
        background: #eef2ff;
        color: #4338ca;
      }

      body.dark .calendar-day {
        background: #1f2937;
        color: #e5e7eb;
      }

      body.dark .calendar-day-emergency {
        background: rgba(248, 113, 113, 0.25);
        color: #fecaca;
      }

      body.dark .calendar-day-maintenance {
        background: rgba(16, 185, 129, 0.25);
        color: #a7f3d0;
      }

      body.dark .calendar-day-routine {
        background: rgba(59, 130, 246, 0.25);
        color: #bfdbfe;
      }

      body.dark .calendar-day-new-client {
        background: rgba(129, 140, 248, 0.25);
        color: #c7d2fe;
      }

      .calendar-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
        font-size: 0.75rem;
        color: #64748b;
      }

      .calendar-legend-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .calendar-legend-swatch {
        width: 12px;
        height: 12px;
        border-radius: 4px;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }

      .modal {
        background: #ffffff;
        border-radius: 12px;
        padding: 1.5rem;
        max-width: 620px;
        width: 100%;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }

      .modal-title {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
      }

      .modal-body {
        max-height: 60vh;
        overflow-y: auto;
        font-size: 0.875rem;
        color: #374151;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      body.dark .modal {
        background: #1f2937;
        color: #e5e7eb;
      }

      body.dark .modal-title {
        color: #f9fafb;
      }

      body.dark .modal-body {
        color: #d1d5db;
      }

      .assistant-root {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 60;
      }

      .assistant-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.6rem 0.9rem;
        border-radius: 999px;
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border: none;
        color: #f9fafb;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
      }

      .assistant-toggle-icon {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .assistant-toggle-icon svg {
        width: 13px;
        height: 13px;
        fill: currentColor;
      }

      .assistant-panel {
        position: absolute;
        bottom: 3.25rem;
        right: 0;
        width: 360px;
        max-height: 520px;
        border-radius: 16px;
        background: #ffffff;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4);
        display: none;
        flex-direction: column;
        overflow: hidden;
      }

      .assistant-header {
        padding: 0.9rem 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .assistant-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #111827;
      }

      .assistant-subtitle {
        font-size: 0.7rem;
        color: #6b7280;
      }

      .assistant-close {
        background: transparent;
        border: none;
        color: #9ca3af;
        padding: 0.25rem;
        cursor: pointer;
      }

      .assistant-messages {
        padding: 0.75rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        overflow-y: auto;
        flex: 1 1 auto;
      }

      .assistant-message {
        font-size: 0.8rem;
        line-height: 1.4;
        border-radius: 10px;
        padding: 0.5rem 0.7rem;
        max-width: 100%;
      }

      .assistant-message-user {
        align-self: flex-end;
        background: #e0e7ff;
        color: #111827;
      }

      .assistant-message-assistant {
        align-self: flex-start;
        background: #f3f4f6;
        color: #111827;
      }

      .assistant-message-system {
        align-self: center;
        background: #eff6ff;
        color: #1d4ed8;
        font-size: 0.75rem;
      }

      .assistant-form {
        border-top: 1px solid #e5e7eb;
        padding: 0.6rem 0.8rem;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .assistant-form textarea {
        resize: none;
        min-height: 56px;
        max-height: 120px;
      }

      .assistant-form-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        font-size: 0.7rem;
      }

      .assistant-status {
        color: #6b7280;
      }

      body.dark .assistant-panel {
        background: #111827;
        border: 1px solid #374151;
      }

      body.dark .assistant-header {
        border-bottom-color: #374151;
      }

      body.dark .assistant-title {
        color: #e5e7eb;
      }

      body.dark .assistant-subtitle {
        color: #9ca3af;
      }

      body.dark .assistant-message-assistant {
        background: #1f2937;
        color: #e5e7eb;
      }

      body.dark .assistant-message-user {
        background: rgba(79, 70, 229, 0.4);
        color: #e5e7eb;
      }

      body.dark .assistant-message-system {
        background: rgba(59, 130, 246, 0.3);
        color: #bfdbfe;
      }

      body.dark .assistant-form {
        border-top-color: #374151;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header-bar">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 15.5c-1.25 0-2.45-.2-3.57-.57-.35-.11-.74-.03-1.02.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.21c.28-.26.36-.65.25-1C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"/>
            </svg>
          </div>
          <div>
            <h1>AI Telephony Dashboard</h1>
            <div style="font-size: 0.75rem; color: #64748b;">Owner Command Center</div>
          </div>
        </div>
        <div class="status-bar">
          <div id="connection-status" class="status-badge muted">
            <span class="status-dot"></span>
            <span>Connecting...</span>
          </div>
          <div class="controls">
            <button id="theme-toggle" type="button">ðŸŒ™ Dark</button>
            <button id="refresh-all" type="button">â†» Refresh</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Container -->
    <div class="container">
      <!-- Owner Authentication -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
            </svg>
          </div>
          <h2>Owner Authentication</h2>
        </div>
        <div class="form-group">
          <label>
            <small>Tenant API Key (X-API-Key)</small>
            <input id="owner-api-key-input" type="password" placeholder="Enter your tenant API key" />
          </label>
        </div>
        <div class="form-group">
          <label>
            <small>Owner Token (X-Owner-Token)</small>
            <input id="owner-token-input" type="password" placeholder="Enter your owner dashboard token" />
          </label>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
          <small id="owner-auth-status" class="muted"></small>
          <span id="owner-plan-label" class="pill" style="display: none;">Plan: Starter</span>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="dashboard-grid">
        <!-- KPI Overview -->
        <div class="card" style="grid-column: span 2;">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
              </svg>
            </div>
            <h2>Key Performance Indicators</h2>
          </div>
          <div class="kpi-grid" id="owner-kpis-content">
            <div class="loading">Loading KPIs</div>
          </div>
          <button id="refresh-owner-kpis" type="button" style="margin-top: 1rem; width: 100%;">Refresh KPIs</button>
        </div>

        <!-- Today's Summary -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
              </svg>
            </div>
            <h2>Today's Jobs</h2>
          </div>
          <div id="today-summary-content">
            <div class="loading">Loading</div>
          </div>
          <button id="refresh-today-summary" type="button" style="margin-top: 1rem; width: 100%;">Refresh</button>
        </div>

        <!-- Tomorrow's Schedule -->
        <div class="card" style="grid-column: span 2;">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
              </svg>
            </div>
            <h2>Tomorrow's Schedule</h2>
          </div>
          <p id="schedule-summary" style="margin-bottom: 1rem; color: #64748b;">Loading schedule...</p>
          <div id="schedule-list"></div>
          <button id="refresh-schedule" type="button" style="margin-top: 1rem; width: 100%;">Refresh Schedule</button>
        </div>

        <!-- Emergency Jobs -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
              </svg>
            </div>
            <h2>Emergency Jobs</h2>
          </div>
          <div id="emergency-content">
            <div class="loading">Loading</div>
          </div>
          <button id="refresh-emergencies" type="button" style="margin-top: 1rem; width: 100%;">Refresh</button>
        </div>

          <!-- Analytics -->
          <div class="card" style="grid-column: span 2;">
            <div class="card-header">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
              </svg>
            </div>
            <h2>Analytics Overview</h2>
          </div>
            <div id="analytics-content">
              <div class="loading">Loading</div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
              <button id="refresh-analytics" type="button" style="flex: 1;">Refresh</button>
              <button id="download-service-mix" type="button" style="flex: 1;">Download CSV</button>
            </div>
          </div>

          <!-- 90-Day Calendar (Tags) -->
          <div class="card" style="grid-column: span 2;" data-min-tier="100">
            <div class="card-header">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M7 10h5v5H7zM3 4h18v2H3zm16 4H5c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2z"/>
                </svg>
              </div>
              <h2>90-Day Calendar (Tags)</h2>
            </div>
            <div id="calendar-90d-content">
              <div class="loading">Loading</div>
            </div>
            <div class="calendar-legend">
              <div class="calendar-legend-item">
                <span class="calendar-legend-swatch" style="background:#fee2e2;"></span>
                <span>Emergency</span>
              </div>
              <div class="calendar-legend-item">
                <span class="calendar-legend-swatch" style="background:#ecfdf5;"></span>
                <span>Maintenance</span>
              </div>
              <div class="calendar-legend-item">
                <span class="calendar-legend-swatch" style="background:#e0f2fe;"></span>
                <span>Routine</span>
              </div>
              <div class="calendar-legend-item">
                <span class="calendar-legend-swatch" style="background:#eef2ff;"></span>
                <span>New client</span>
              </div>
            </div>
          </div>
  
          <!-- Market by ZIP (Wealth & Value) -->
          <div class="card" style="grid-column: span 2;" data-min-tier="100">
            <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L4 5v6c0 5.52 3.84 10.74 9 12 5.16-1.26 9-6.48 9-12V5l-8-3zm0 2.18L18.16 7 12 9.82 5.84 7 12 4.18zM5 9l7 3 7-3v3c0 4.07-2.75 8.12-7 9.44C7.75 20.12 5 16.07 5 12V9z"/>
              </svg>
            </div>
            <h2>Market by ZIP (Wealth & Value)</h2>
          </div>
          <div id="zip-wealth-content">
            <div class="loading">Loading</div>
          </div>
        </div>

        <!-- Service Metrics (Price & Time) -->
        <div class="card" style="grid-column: span 2;" data-min-tier="100">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 17h2v-7H3v7zm4 0h2V7H7v10zm4 0h2v-4h-2v4zm4 0h2V3h-2v14zM3 19h18v2H3z"/>
              </svg>
            </div>
            <h2>Service Metrics (Price & Time)</h2>
          </div>
          <div id="service-metrics-content">
            <div class="loading">Loading</div>
          </div>
        </div>

        <!-- Conversations -->
        <div class="card" style="grid-column: span 2;">
          <div class="card-header">
            <div class="card-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>
              </svg>
            </div>
            <h2>Recent Conversations</h2>
          </div>
          <div id="conversations-list">
            <div class="loading">Loading</div>
          </div>
          <div id="conversation-detail" style="margin-top: 1rem;"></div>
          <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button id="refresh-conversations" type="button" style="flex: 1;">Refresh</button>
            <button id="download-conversations" type="button" style="flex: 1;">Download CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Calendar report modal -->
    <div id="calendar-report-modal" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="calendar-modal-title">
        <div class="modal-header">
          <div>
            <div id="calendar-modal-title" class="modal-title">Schedule report</div>
            <div style="font-size: 0.75rem; color: #6b7280;">90-day calendar tags summarized for the selected day.</div>
          </div>
          <button id="calendar-modal-close" type="button" class="assistant-close" aria-label="Close schedule report">&times;</button>
        </div>
        <div id="calendar-modal-body" class="modal-body">
          <div class="loading">Preparing report...</div>
        </div>
        <div class="modal-footer">
          <button id="calendar-modal-download" type="button">Download PDF</button>
          <button id="calendar-modal-dismiss" type="button">Close</button>
        </div>
      </div>
    </div>

    <!-- Owner assistant bubble -->
    <div id="owner-assistant-root" class="assistant-root">
      <button id="owner-assistant-toggle" type="button" class="assistant-toggle">
        <span class="assistant-toggle-icon">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 4h16v10H5.17L4 15.17V4zm0-2c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4zm4 9h8v2H8v-2zm0-3h8v2H8V8z"/>
          </svg>
        </span>
        <span>Ask the dashboard</span>
      </button>
      <div id="owner-assistant-panel" class="assistant-panel" aria-hidden="true">
        <div class="assistant-header">
          <div>
            <div class="assistant-title">AI Owner Assistant</div>
            <div class="assistant-subtitle">Ask about metrics, data, policies, or support.</div>
          </div>
          <button id="owner-assistant-close" type="button" class="assistant-close" aria-label="Close assistant">&times;</button>
        </div>
        <div id="owner-assistant-messages" class="assistant-messages">
          <div class="assistant-message assistant-message-system">
            Ask me about today's jobs, emergency volume, service metrics, your customers, or privacy and security policies.
          </div>
        </div>
        <form id="owner-assistant-form" class="assistant-form">
          <textarea
            id="owner-assistant-input"
            rows="2"
            placeholder="Ask a question about this dashboard, your metrics, data, policies, or support..."
          ></textarea>
          <div class="assistant-form-actions">
            <span id="owner-assistant-status" class="assistant-status"></span>
            <button id="owner-assistant-send" type="submit">Ask</button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      const DEFAULT_BACKEND_BASE = "http://localhost:8000";
      const backendBase = DEFAULT_BACKEND_BASE;
      let apiKey = localStorage.getItem("owner_api_key") || "";
      let ownerToken = localStorage.getItem("owner_owner_token") || "";
      let calendar90dData = null;
      let ownerAssistantOpen = false;
      let ownerAssistantBusy = false;
      let ownerServiceTier = null;

      function updateConnectionStatus(state) {
        const el = document.getElementById("connection-status");
        if (!el) return;
        
        const dot = el.querySelector(".status-dot");
        const text = el.querySelector("span:last-child");
        
        if (state === "ok") {
          el.className = "status-badge success";
          text.textContent = "Connected";
        } else if (state === "error") {
          el.className = "status-badge error";
          text.textContent = "Connection Error";
        } else {
          el.className = "status-badge muted";
          text.textContent = "Connecting...";
        }
      }

      function authHeaders() {
        const headers = {};
        if (apiKey) headers["X-API-Key"] = apiKey;
        if (ownerToken) headers["X-Owner-Token"] = ownerToken;
        return headers;
      }

      async function fetchJson(path) {
        try {
          const res = await fetch(backendBase + path, { headers: authHeaders() });
          if (!res.ok) {
            updateConnectionStatus("error");
            throw new Error("Request failed: " + res.status);
          }
          updateConnectionStatus("ok");
          return res.json();
        } catch (err) {
          updateConnectionStatus("error");
          throw err;
        }
      }

      function escapeHtml(value) {
        if (value === null || value === undefined) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function formatPercent(value) {
        if (value === null || value === undefined || isNaN(value)) {
          return "0%";
        }
        const pct = Math.round(Number(value) * 100);
        return `${pct}%`;
      }

      function formatMinutes(value) {
        if (value === null || value === undefined || isNaN(value)) {
          return "0m";
        }
        const minutes = Math.max(0, Math.round(Number(value)));
        if (minutes < 60) {
          return `${minutes}m`;
        }
        const hours = Math.floor(minutes / 60);
        const rem = minutes % 60;
        return rem ? `${hours}h ${rem}m` : `${hours}h`;
      }

      function formatCurrency(value) {
        if (value === null || value === undefined || isNaN(value)) {
          return "0";
        }
        const num = Number(value);
        return num.toLocaleString(undefined, { maximumFractionDigits: 0 });
      }

      function tierCodeToLabel(tier) {
        if (!tier) return "Unselected";
        if (tier === "20") return "Starter ($20/mo)";
        if (tier === "100") return "Growth ($100/mo)";
        if (tier === "200") return "Scale ($200/mo)";
        return tier;
      }

      function tierCodeToNumber(tier) {
        if (!tier) return 0;
        const n = Number(tier);
        return Number.isFinite(n) ? n : 0;
      }

      function featureEnabledForTier(requiredTierCode) {
        const required = tierCodeToNumber(requiredTierCode);
        const actual = tierCodeToNumber(ownerServiceTier);
        if (!required || !actual) return true;
        return actual >= required;
      }

      async function loadOwnerKpis() {
        const el = document.getElementById("owner-kpis-content");
        if (!el) return;
        el.innerHTML = '<div class="loading">Loading KPIs</div>';

        try {
          const [customers, sms, ttb, funnel, completeness] = await Promise.all([
            fetchJson("/v1/owner/customers/analytics?days=365"),
            fetchJson("/v1/owner/sms-metrics"),
            fetchJson("/v1/owner/time-to-book?days=90"),
            fetchJson("/v1/owner/conversion-funnel?days=90"),
            fetchJson("/v1/owner/data-completeness?days=365"),
          ]);

          const kpis = [];

          const convRate = funnel && typeof funnel.overall_conversion_rate === "number"
            ? funnel.overall_conversion_rate
            : null;
          if (convRate !== null) {
            kpis.push({ label: "Conversion", value: formatPercent(convRate) });
          }

          const avgMinutes = ttb && typeof ttb.overall_average_minutes === "number"
            ? ttb.overall_average_minutes
            : null;
          if (avgMinutes !== null) {
            kpis.push({ label: "Avg Time to Book", value: formatMinutes(avgMinutes) });
          }

          const repeatShare = customers && customers.economics && typeof customers.economics.repeat_customer_share === "number"
            ? customers.economics.repeat_customer_share
            : null;
          if (repeatShare !== null) {
            kpis.push({ label: "Repeat Work", value: formatPercent(repeatShare) });
          }

          const smsShare = sms && typeof sms.confirmation_share_via_sms === "number"
            ? sms.confirmation_share_via_sms
            : null;
          if (smsShare !== null) {
            kpis.push({ label: "SMS Confirms", value: formatPercent(smsShare) });
          }

          const completenessScore = completeness && typeof completeness.appointment_completeness_score === "number"
            ? completeness.appointment_completeness_score
            : null;
          if (completenessScore !== null) {
            kpis.push({ label: "Data Complete", value: formatPercent(completenessScore) });
          }

          if (!kpis.length) {
            el.innerHTML = '<div class="empty-state">No KPI data yet</div>';
            return;
          }

          el.innerHTML = kpis.map(kpi => `
            <div class="kpi-card">
              <div class="kpi-value">${escapeHtml(kpi.value)}</div>
              <div class="kpi-label">${escapeHtml(kpi.label)}</div>
            </div>
          `).join("");
        } catch (err) {
          el.innerHTML = '<div class="empty-state">Unable to load KPIs</div>';
        }
      }

      async function loadTodaySummary() {
        const el = document.getElementById("today-summary-content");
        if (!el) return;
        el.innerHTML = '<div class="loading">Loading</div>';
        
        try {
          const data = await fetchJson("/v1/owner/summary/today");
          const total = data?.total_appointments ?? 0;
          const emergency = data?.emergency_appointments ?? 0;
          const standard = data?.standard_appointments ?? 0;

          el.innerHTML = `
            <div class="metric-row">
              <span class="metric-label">Total Jobs</span>
              <span class="metric-value">${escapeHtml(total)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Emergency</span>
              <span class="metric-value" style="color: #ef4444;">${escapeHtml(emergency)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Standard</span>
              <span class="metric-value">${escapeHtml(standard)}</span>
            </div>
          `;
        } catch (err) {
          el.innerHTML = '<div class="empty-state">Unable to load summary</div>';
        }
      }

      async function loadSchedule() {
        const summaryEl = document.getElementById("schedule-summary");
        const listEl = document.getElementById("schedule-list");
        if (!summaryEl || !listEl) return;
        
        summaryEl.textContent = "Loading...";
        listEl.innerHTML = "";
        
        try {
          const data = await fetchJson("/v1/owner/schedule/tomorrow");
          const appointments = Array.isArray(data?.appointments) ? data.appointments : [];

          summaryEl.textContent = data?.reply_text || `You have ${appointments.length} appointments scheduled for tomorrow.`;

          if (!appointments.length) {
            listEl.innerHTML = '<div class="empty-state">No appointments scheduled for tomorrow</div>';
            return;
          }

          listEl.innerHTML = appointments.map(apt => {
            const start = apt.start_time ? new Date(apt.start_time) : null;
            const timeLabel = start && !isNaN(start.getTime())
              ? start.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" })
              : "";
            const tag = apt.is_emergency ? "emergency" : "normal";
            return `
              <div class="metric-row">
                <div>
                  <div style="font-weight: 600;">${escapeHtml(apt.customer_name || "Customer")}</div>
                  <div style="font-size: 0.875rem; color: #64748b;">${escapeHtml(timeLabel)}</div>
                </div>
                <span class="tag tag-${tag}">${tag}</span>
              </div>
            `;
          }).join("");
        } catch (err) {
          summaryEl.textContent = "Unable to load schedule";
        }
      }

      async function loadEmergencyJobs() {
        const el = document.getElementById("emergency-content");
        if (!el) return;
        el.innerHTML = '<div class="loading">Loading</div>';
        
        try {
          const [today, week, month] = await Promise.all([
            fetchJson("/v1/owner/service-mix?days=1"),
            fetchJson("/v1/owner/service-mix?days=7"),
            fetchJson("/v1/owner/service-mix?days=30"),
          ]);

          const todayEmerg = today?.emergency_appointments_30d ?? 0;
          const weekEmerg = week?.emergency_appointments_30d ?? 0;
          const monthEmerg = month?.emergency_appointments_30d ?? 0;

          el.innerHTML = `
            <div class="metric-row">
              <span class="metric-label">Today</span>
              <span class="metric-value">${escapeHtml(todayEmerg)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Last 7 Days</span>
              <span class="metric-value">${escapeHtml(weekEmerg)}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Last 30 Days</span>
              <span class="metric-value">${escapeHtml(monthEmerg)}</span>
            </div>
          `;
        } catch (err) {
          el.innerHTML = '<div class="empty-state">Unable to load emergency data</div>';
        }
      }

      async function loadAnalytics() {
        const el = document.getElementById("analytics-content");
        if (!el) return;
        el.innerHTML = '<div class="loading">Loading</div>';

        try {
          const [mix, customers, funnel] = await Promise.all([
            fetchJson("/v1/owner/service-mix?days=30"),
            fetchJson("/v1/owner/customers/analytics?days=365"),
            fetchJson("/v1/owner/conversion-funnel?days=90"),
          ]);

          const total30 = mix?.total_appointments_30d ?? 0;
          const emergency30 = mix?.emergency_appointments_30d ?? 0;
          const emergencyShare = total30 > 0 ? emergency30 / total30 : 0;

          const repeatShare = customers?.economics?.repeat_customer_share ?? 0;
          const convRate = funnel?.overall_conversion_rate ?? 0;

          el.innerHTML = `
            <div class="feature-grid">
              <div class="feature-item">
                <div class="feature-icon">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="white" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                  </svg>
                </div>
                <div>
                  <div style="font-weight: 600;">${escapeHtml(total30)}</div>
                  <div style="font-size: 0.75rem; color: #64748b;">Appointments (Last 30 Days)</div>
                </div>
              </div>
              <div class="feature-item">
                <div class="feature-icon">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="white" d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                  </svg>
                </div>
                <div>
                  <div style="font-weight: 600;">${escapeHtml(formatPercent(emergencyShare))}</div>
                  <div style="font-size: 0.75rem; color: #64748b;">Emergency Share (30 Days)</div>
                </div>
              </div>
              <div class="feature-item">
                <div class="feature-icon">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="white" d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm0 15l-4-4 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/>
                  </svg>
                </div>
                <div>
                  <div style="font-weight: 600;">${escapeHtml(formatPercent(repeatShare))}</div>
                  <div style="font-size: 0.75rem; color: #64748b;">Repeat Work Share</div>
                </div>
              </div>
              <div class="feature-item">
                <div class="feature-icon">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="white" d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm0 15l-4-4 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/>
                  </svg>
                </div>
                <div>
                  <div style="font-weight: 600;">${escapeHtml(formatPercent(convRate))}</div>
                  <div style="font-size: 0.75rem; color: #64748b;">Lead â†’ Booked Conversion</div>
                </div>
              </div>
            </div>
          `;
        } catch (err) {
          el.innerHTML = '<div class="empty-state">Unable to load analytics</div>';
        }
      }

        async function loadZipWealth() {
          const el = document.getElementById("zip-wealth-content");
          if (!el) return;
          if (!featureEnabledForTier("100")) {
            el.innerHTML = '<div class="empty-state">Upgrade to the Growth plan ($100/mo) to unlock market-by-ZIP analytics.</div>';
            return;
          }
          el.innerHTML = '<div class="loading">Loading</div>';
        try {
          const data = await fetchJson("/v1/owner/neighborhoods?days=365");
          const items = Array.isArray(data?.items) ? data.items : [];
          if (!items.length) {
            el.innerHTML = '<div class="empty-state">No ZIP-level data available yet</div>';
            return;
          }
          const rows = items
            .filter(item => typeof item.label === "string" && item.label.length > 0)
            .map(item => {
              const zip = String(item.label);
              const value = Number(item.estimated_value_total || 0);
              const income = item.median_household_income;
              let band = "Unknown";
              let color = "#e2e8f0";
              if (typeof income === "number") {
                if (income < 50000) {
                  band = "< $50k";
                  color = "#bfdbfe";
                } else if (income < 80000) {
                  band = "$50k - $80k";
                  color = "#fed7aa";
                } else {
                  band = "â‰¥ $80k";
                  color = "#bbf7d0";
                }
              }
              return { zip, value, income, band, color, appointments: item.appointments || 0 };
            })
            .sort((a, b) => b.value - a.value);

          el.innerHTML = `
            <div class="kpi-grid">
              ${rows.map(row => `
                <div class="metric-row" style="background: ${row.color}; border-radius: 12px; padding: 0.75rem 0.9rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-weight: 600;">ZIP ${escapeHtml(row.zip)}</div>
                      <div style="font-size: 0.75rem; color: #475569;">
                        Jobs: ${row.appointments} Â· Value: $${formatCurrency(row.value)}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 0.8rem; font-weight: 600;">
                        ${row.income ? "$" + formatCurrency(row.income) : "No income data"}
                      </div>
                      <div style="font-size: 0.75rem; color: #475569;">${row.band}</div>
                    </div>
                  </div>
                </div>
              `).join("")}
            </div>
          `;
        } catch (err) {
          console.error("Error loading ZIP wealth data", err);
          el.innerHTML = '<div class="empty-state">Unable to load ZIP/wealth data</div>';
        }
      }

        async function loadServiceMetrics() {
          const el = document.getElementById("service-metrics-content");
          if (!el) return;
          if (!featureEnabledForTier("100")) {
            el.innerHTML = '<div class="empty-state">Upgrade to the Growth plan ($100/mo) to unlock detailed service metrics.</div>';
            return;
          }
          el.innerHTML = '<div class="loading">Loading</div>';
        try {
          const data = await fetchJson("/v1/owner/service-metrics?days=90");
          const items = Array.isArray(data?.items) ? data.items : [];
          if (!items.length) {
            el.innerHTML = '<div class="empty-state">No service metrics available yet</div>';
            return;
          }
          const rows = items.map(item => {
            const svc = item.service_type || "(unspecified)";
            const jobs = item.appointments || 0;
            const totalValue = item.estimated_value_total || 0;
            const avgValue = item.estimated_value_average || 0;
            const minDur = item.scheduled_minutes_min;
            const maxDur = item.scheduled_minutes_max;
            const avgDur = item.scheduled_minutes_average;
            return {
              svc,
              jobs,
              totalValue,
              avgValue,
              minDur,
              maxDur,
              avgDur,
            };
          }).sort((a, b) => b.totalValue - a.totalValue);

          el.innerHTML = `
            <div class="kpi-grid">
              ${rows.map(row => `
                <div class="metric-row">
                  <div>
                    <div style="font-weight: 600;">${escapeHtml(row.svc)}</div>
                    <div style="font-size: 0.75rem; color: #64748b;">
                      Jobs: ${row.jobs} Â· Avg Price: $${formatCurrency(row.avgValue)}
                    </div>
                  </div>
                  <div style="text-align: right; font-size: 0.75rem; color: #475569;">
                    <div>Avg Time: ${formatMinutes(row.avgDur)}</div>
                    <div>Range: ${formatMinutes(row.minDur)} â€“ ${formatMinutes(row.maxDur)}</div>
                  </div>
                </div>
              `).join("")}
            </div>
          `;
        } catch (err) {
            console.error("Error loading service metrics", err);
            el.innerHTML = '<div class="empty-state">Unable to load service metrics</div>';
          }
        }

        async function loadCalendar90d() {
          const container = document.getElementById("calendar-90d-content");
          if (!container) return;
          if (!featureEnabledForTier("100")) {
            container.innerHTML = '<div class="empty-state">Upgrade to the Growth plan ($100/mo) to unlock the 90-day calendar.</div>';
            return;
          }
          container.innerHTML = '<div class="loading">Loading</div>';

          try {
            const data = await fetchJson("/v1/owner/calendar/90d");
            calendar90dData = data;
            const days = Array.isArray(data?.days) ? data.days : [];
            if (!days.length) {
              container.innerHTML = '<div class="empty-state">No appointments in the next 90 days</div>';
              return;
            }

            const gridHtml = `
              <div class="calendar-grid">
                ${days.map(day => {
                  const date = day.date;
                  const total = day.total_appointments || 0;
                  const tags = day.tag_counts || {};
                  const emergency = tags.emergency || tags["emergency"] || 0;
                  const maintenance = tags.maintenance || tags["maintenance"] || 0;
                  const newClients = tags.new_client || tags["new_client"] || 0;
                  const routine = tags.routine || tags["routine"] || 0;
                  const classes = ["calendar-day"];
                  if (emergency > 0) classes.push("calendar-day-emergency");
                  else if (newClients > 0) classes.push("calendar-day-new-client");
                  else if (maintenance > 0) classes.push("calendar-day-maintenance");
                  else if (routine > 0) classes.push("calendar-day-routine");
                  const label = typeof date === "string" ? date.slice(5) : "";
                  const title = total === 1 ? "1 job" : `${total} jobs`;
                  return `
                    <button
                      type="button"
                      class="${classes.join(" ")}"
                      data-calendar-date="${escapeHtml(date)}"
                      title="${escapeHtml(title)}"
                    >
                      <div class="calendar-day-date">${escapeHtml(label)}</div>
                      <div class="calendar-day-total">${escapeHtml(total)}</div>
                    </button>
                  `;
                }).join("")}
              </div>
            `;
            container.innerHTML = gridHtml;

            const buttons = container.querySelectorAll("[data-calendar-date]");
            buttons.forEach((btn) => {
              btn.addEventListener("click", () => {
                const dateStr = btn.getAttribute("data-calendar-date");
                if (dateStr) {
                  openCalendarModal(dateStr);
                }
              });
            });
          } catch (err) {
            console.error("Error loading 90-day calendar", err);
            container.innerHTML = '<div class="empty-state">Unable to load 90-day calendar</div>';
          }
        }

        function openCalendarModal(dateStr) {
          const modal = document.getElementById("calendar-report-modal");
          const body = document.getElementById("calendar-modal-body");
          const titleEl = document.getElementById("calendar-modal-title");
          if (!modal || !body || !titleEl || !calendar90dData) return;

          const days = Array.isArray(calendar90dData.days) ? calendar90dData.days : [];
          const day = days.find((d) => d.date === dateStr);

          titleEl.textContent = `Schedule report for ${dateStr}`;

          if (!day) {
            body.innerHTML = '<div class="empty-state">No appointments scheduled for this day</div>';
          } else {
            const tags = day.tag_counts || {};
            const services = day.service_type_counts || {};
            const total = day.total_appointments || 0;
            const newCustomers = day.new_customers || 0;
            const estTotal = day.estimated_value_total || 0;
            const estAvg = day.estimated_value_average;

            const tagRows = Object.keys(tags)
              .sort()
              .map((tag) => {
                const count = tags[tag] ?? 0;
                return `
                  <tr>
                    <td style="padding: 0.1rem 0.5rem;">${escapeHtml(tag)}</td>
                    <td style="padding: 0.1rem 0.5rem; text-align: right;">${escapeHtml(count)}</td>
                  </tr>
                `;
              })
              .join("");

            const svcRows = Object.keys(services)
              .sort()
              .map((svc) => {
                const count = services[svc] ?? 0;
                return `
                  <tr>
                    <td style="padding: 0.1rem 0.5rem;">${escapeHtml(svc)}</td>
                    <td style="padding: 0.1rem 0.5rem; text-align: right;">${escapeHtml(count)}</td>
                  </tr>
                `;
              })
              .join("");

            const overviewLine = (() => {
              const base = `Total jobs: ${escapeHtml(total)} | New customers: ${escapeHtml(newCustomers)} | Estimated value: $${formatCurrency(estTotal)}`;
              if (estAvg !== null && estAvg !== undefined && !isNaN(estAvg)) {
                return `${base} (avg $${formatCurrency(estAvg)})`;
              }
              return base;
            })();

            body.innerHTML = `
              <div style="margin-bottom: 0.75rem;">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">Overview</div>
                <div style="font-size: 0.8rem; color: #4b5563;">
                  ${overviewLine}
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
                <div>
                  <div style="font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">By tag</div>
                  ${
                    tagRows
                      ? `<table style="width: 100%; font-size: 0.8rem;">${tagRows}</table>`
                      : '<div class="empty-state" style="padding: 0.5rem 0; font-size: 0.8rem;">No tag data</div>'
                  }
                </div>
                <div>
                  <div style="font-weight: 600; font-size: 0.8rem; margin-bottom: 0.25rem;">By service type</div>
                  ${
                    svcRows
                      ? `<table style="width: 100%; font-size: 0.8rem;">${svcRows}</table>`
                      : '<div class="empty-state" style="padding: 0.5rem 0; font-size: 0.8rem;">No service-type data</div>'
                  }
                </div>
              </div>
            `;
          }

          modal.dataset.date = dateStr;
          modal.style.display = "flex";
          modal.setAttribute("aria-hidden", "false");
        }

        function closeCalendarModal() {
          const modal = document.getElementById("calendar-report-modal");
          if (!modal) return;
          modal.style.display = "none";
          modal.setAttribute("aria-hidden", "true");
          delete modal.dataset.date;
        }

        function initCalendarModal() {
          const closeButton = document.getElementById("calendar-modal-close");
          const dismissButton = document.getElementById("calendar-modal-dismiss");
          const downloadButton = document.getElementById("calendar-modal-download");
          const modal = document.getElementById("calendar-report-modal");

          closeButton?.addEventListener("click", closeCalendarModal);
          dismissButton?.addEventListener("click", closeCalendarModal);

          if (modal) {
            modal.addEventListener("click", (evt) => {
              if (evt.target === modal) {
                closeCalendarModal();
              }
            });
          }

          downloadButton?.addEventListener("click", () => {
            if (!modal) return;
            const dateStr = modal.dataset.date;
            if (!dateStr) return;
            const url = `${backendBase}/v1/owner/calendar/report.pdf?day=${encodeURIComponent(dateStr)}`;
            window.open(url, "_blank");
          });
        }
      async function loadConversations() {
        const listEl = document.getElementById("conversations-list");
        const detailEl = document.getElementById("conversation-detail");
        if (!listEl) return;
        listEl.innerHTML = '<div class="loading">Loading</div>';
        if (detailEl) detailEl.innerHTML = "";

        try {
          const data = await fetchJson("/v1/owner/conversations/review");
          const items = Array.isArray(data?.items) ? data.items : [];

          if (!items.length) {
            listEl.innerHTML = '<div class="empty-state">No flagged or emergency conversations</div>';
            return;
          }

          listEl.innerHTML = items.map(conv => `
            <div class="metric-row" data-conversation-id="${escapeHtml(conv.id)}">
              <div>
                <div style="font-weight: 600;">${escapeHtml(conv.customer_name || "Unknown customer")}</div>
                <div style="font-size: 0.75rem; color: #64748b;">
                  ${escapeHtml(String(conv.channel || "").toUpperCase())}
                </div>
                <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">
                  ${escapeHtml(conv.outcome || "")}
                </div>
              </div>
            </div>
          `).join("");

          listEl.querySelectorAll(".metric-row").forEach(row => {
            row.addEventListener("click", () => {
              if (!detailEl) return;
              const id = row.getAttribute("data-conversation-id") || "";
              const conv = items.find(c => c.id === id);
              if (!conv) return;
              const created = conv.created_at ? new Date(conv.created_at) : null;
              const createdLabel = created && !isNaN(created.getTime())
                ? created.toLocaleString()
                : "";
              detailEl.innerHTML = `
                <div style="padding-top: 1rem; border-top: 1px solid #f1f5f9;">
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(conv.customer_name || "Unknown customer")}</div>
                  <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">
                    Channel: ${escapeHtml(conv.channel || "")}
                  </div>
                  <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem;">
                    Created: ${escapeHtml(createdLabel)}
                  </div>
                  <div style="font-size: 0.875rem; color: #4b5563;">${escapeHtml(conv.outcome || "")}</div>
                </div>
              `;
            });
          });
        } catch (err) {
          listEl.innerHTML = '<div class="empty-state">Unable to load conversations</div>';
          if (detailEl) detailEl.innerHTML = "";
        }
      }

      function appendAssistantMessage(role, text) {
        const container = document.getElementById("owner-assistant-messages");
        if (!container) return;
        const div = document.createElement("div");
        div.className = "assistant-message";
        if (role === "user") {
          div.classList.add("assistant-message-user");
        } else if (role === "assistant") {
          div.classList.add("assistant-message-assistant");
        } else {
          div.classList.add("assistant-message-system");
        }
        div.textContent = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }

      async function askOwnerAssistant(question) {
        const statusEl = document.getElementById("owner-assistant-status");
        if (!question || !question.trim()) return null;
        if (ownerAssistantBusy) return null;
        if (!featureEnabledForTier("100")) {
          if (statusEl) {
            statusEl.textContent = "The owner assistant is a Growth/Scale feature; responses may be limited in Starter.";
          }
        }
        ownerAssistantBusy = true;
        if (statusEl) statusEl.textContent = "Thinking...";

        try {
          const res = await fetch(`${backendBase}/v1/owner/assistant/query`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...authHeaders(),
            },
            body: JSON.stringify({ question }),
          });
          if (!res.ok) {
            const msg = `Error ${res.status}`;
            if (statusEl) statusEl.textContent = msg;
            return null;
          }
          const data = await res.json();
          if (statusEl) statusEl.textContent = "";
          return data;
        } catch (err) {
          console.error("Error calling owner assistant", err);
          if (statusEl) statusEl.textContent = "Unable to reach assistant";
          return null;
        } finally {
          ownerAssistantBusy = false;
        }
      }

      function initOwnerAssistant() {
        const toggle = document.getElementById("owner-assistant-toggle");
        const panel = document.getElementById("owner-assistant-panel");
        const closeBtn = document.getElementById("owner-assistant-close");
        const form = document.getElementById("owner-assistant-form");
        const input = document.getElementById("owner-assistant-input");

        if (!toggle || !panel || !form || !input) {
          return;
        }

        // If the tenant is on Starter tier, keep the UI visible but
        // remind them this assistant is a Growth feature when they open it.
        const isGrowthOrHigher = featureEnabledForTier("100");

        function setOpen(open) {
          ownerAssistantOpen = open;
          panel.style.display = open ? "flex" : "none";
          panel.setAttribute("aria-hidden", open ? "false" : "true");
          if (open) {
            input.focus();
          }
        }

        toggle.addEventListener("click", () => {
          if (!isGrowthOrHigher) {
            const status = document.getElementById("owner-assistant-status");
            if (status) {
              status.textContent = "The owner assistant is optimized for Growth and Scale plans; you can still try it in this proof of concept.";
              status.className = "assistant-status";
            }
          }
          setOpen(!ownerAssistantOpen);
        });

        closeBtn?.addEventListener("click", () => {
          setOpen(false);
        });

        form.addEventListener("submit", async (evt) => {
          evt.preventDefault();
          const question = (input.value || "").trim();
          if (!question) return;
          appendAssistantMessage("user", question);
          input.value = "";
          const data = await askOwnerAssistant(question);
          const answer =
            data && typeof data.answer === "string"
              ? data.answer
              : "I was not able to generate an answer. Please try again.";
          appendAssistantMessage("assistant", answer);
        });
      }

      async function loadOwnerOnboardingProfile() {
        try {
          const data = await fetchJson("/v1/owner/onboarding/profile");
          ownerServiceTier = data && typeof data.service_tier === "string" ? data.service_tier : null;
          const labelEl = document.getElementById("owner-plan-label");
          if (labelEl) {
            const label = tierCodeToLabel(ownerServiceTier);
            labelEl.textContent = `Plan: ${label}`;
            labelEl.style.display = "inline-flex";
          }
        } catch (err) {
          // On failure, keep tier unset and let features load as default.
        }
      }

      function initAuth() {
        const apiInput = document.getElementById("owner-api-key-input");
        const tokenInput = document.getElementById("owner-token-input");
        const statusEl = document.getElementById("owner-auth-status");

        if (apiInput) {
          if (apiKey) apiInput.value = apiKey;
          apiInput.addEventListener("change", (e) => {
            apiKey = (e.target.value || "").trim();
            if (apiKey) {
              localStorage.setItem("owner_api_key", apiKey);
              if (statusEl) {
                statusEl.textContent = "API key saved";
                statusEl.className = "success";
              }
            } else {
              localStorage.removeItem("owner_api_key");
              if (statusEl) {
                statusEl.textContent = "API key cleared";
                statusEl.className = "muted";
              }
            }
          });
        }

        if (tokenInput) {
          if (ownerToken) tokenInput.value = ownerToken;
          tokenInput.addEventListener("change", (e) => {
            ownerToken = (e.target.value || "").trim();
            if (ownerToken) {
              localStorage.setItem("owner_owner_token", ownerToken);
              if (statusEl) {
                statusEl.textContent = "Owner token saved";
                statusEl.className = "success";
              }
            } else {
              localStorage.removeItem("owner_owner_token");
              if (statusEl) {
                statusEl.textContent = "Owner token cleared";
                statusEl.className = "muted";
              }
            }
          });
        }
      }

      function initThemeToggle() {
        const themeToggle = document.getElementById("theme-toggle");
        const storedTheme = localStorage.getItem("owner_theme") || "light";
        if (storedTheme === "dark") {
          document.body.classList.add("dark");
        }
        if (themeToggle) {
          const refreshLabel = () => {
            const isDark = document.body.classList.contains("dark");
            themeToggle.textContent = isDark ? "Light Mode" : "Dark Mode";
          };
          refreshLabel();
          themeToggle.addEventListener("click", () => {
            const isDark = document.body.classList.toggle("dark");
            localStorage.setItem("owner_theme", isDark ? "dark" : "light");
            refreshLabel();
          });
        }
      }

      function initButtons() {
        document.getElementById("refresh-owner-kpis")?.addEventListener("click", loadOwnerKpis);
        document.getElementById("refresh-today-summary")?.addEventListener("click", loadTodaySummary);
        document.getElementById("refresh-schedule")?.addEventListener("click", loadSchedule);
        document.getElementById("refresh-emergencies")?.addEventListener("click", loadEmergencyJobs);
        document.getElementById("refresh-analytics")?.addEventListener("click", loadAnalytics);
        document.getElementById("refresh-conversations")?.addEventListener("click", loadConversations);

        document.getElementById("download-service-mix")?.addEventListener("click", () => {
          window.open(backendBase + "/v1/owner/export/service-mix.csv", "_blank");
        });
        document.getElementById("download-conversations")?.addEventListener("click", () => {
          window.open(backendBase + "/v1/owner/export/conversations.csv", "_blank");
        });

        document.getElementById("refresh-all")?.addEventListener("click", () => {
          loadOwnerKpis();
          loadTodaySummary();
          loadSchedule();
          loadEmergencyJobs();
          loadAnalytics();
          loadZipWealth();
          loadCalendar90d();
          loadServiceMetrics();
          loadConversations();
        });
      }

      window.addEventListener("DOMContentLoaded", () => {
        updateConnectionStatus("connecting");
        initAuth();
        initThemeToggle();
        initButtons();
        initCalendarModal();
        initOwnerAssistant();
        loadOwnerOnboardingProfile();
        loadOwnerKpis();
        loadTodaySummary();
        loadSchedule();
        loadEmergencyJobs();
        loadAnalytics();
        loadZipWealth();
        loadCalendar90d();
        loadServiceMetrics();
        loadConversations();
      });
    </script>
  </body>
</html>
