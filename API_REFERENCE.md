API Reference
=============

This document summarizes the primary HTTP APIs exposed by the AI Telephony Service & CRM backend.
It is grouped by functional area and focuses on:

- Route paths and HTTP verbs.
- Typical auth headers.
- High-level purpose for each endpoint.

For full request/response models, use the autogenerated docs at `http://localhost:8000/docs`.


Auth & Headers
--------------

- Tenant identification:
  - `X-API-Key`: per-tenant API key (recommended).
  - `X-Business-ID`: optional explicit tenant identifier (trusted only in controlled environments).
  - `X-Widget-Token`: per-tenant widget token for web chat.
- Owner/CRM access:
  - `X-Owner-Token`: owner/dashboard token for `/v1/owner/*` and `/v1/crm/*` via the dashboards.
- Admin access:
  - `X-Admin-API-Key`: admin key for `/v1/admin/*`.

In production, set `REQUIRE_BUSINESS_API_KEY=true` so CRM/owner/widget/telephony routes always run
in a tenant context and anonymous/default-tenant traffic is rejected.


Health & Metrics
----------------

- `GET /healthz`
  - No auth.
  - Basic liveness probe: returns `{"status": "ok"}` when the backend is healthy.

- `GET /metrics`
  - No auth by default (protect with network/firewall or auth in production).
  - Returns JSON counters such as:
    - `total_requests`, `total_errors`, `appointments_scheduled`.
    - `sms_sent_total`, `sms_sent_owner`, `sms_sent_customer`, `lead_followups_sent`.
    - `sms_by_business[business_id].*` for per-tenant SMS and retention metrics.
    - `twilio_voice_requests`, `twilio_sms_requests` and error counts.
    - `twilio_by_business[business_id].*` for per-tenant webhook metrics.
    - `voice_session_requests`, `voice_session_errors`, and `voice_sessions_by_business`.
    - `route_metrics[path].*` with per-route request/error counts and latency.
    - `callbacks_by_business` and `retention_by_business` for callback and retention campaigns.

- `GET /metrics/prometheus`
  - No auth by default.
  - Minimal Prometheus text-format view of key global counters and per-route request/error counts.


Voice Session API (`/v1/voice/*`)
---------------------------------

Headers:

- `X-API-Key` (recommended) or `X-Business-ID` to scope the tenant.

Endpoints:

- `POST /v1/voice/session/start`
  - Body: `{ "caller_phone": "555-0000", "provider_call_id": "...", "lead_source": "..." }`
  - Response: `{ "session_id": "..." }`
  - Starts a logical voice session and creates a `Conversation` row.

- `POST /v1/voice/session/{session_id}/input`
  - Body: `{ "text": "John Smith" }` or `{ "audio": "<base64>" }`.
  - Response: `{ "reply_text": "...", "session_state": {...}, "audio": "<base64 or placeholder>" }`
  - Feeds caller input into the conversation manager; returns the next turn.

- `POST /v1/voice/session/{session_id}/end`
  - Response: `{ "status": "ended:<session_id>" }`
  - Marks the session as ended in the in-memory store.


Telephony API (`/telephony/*`, `/v1/telephony/*`)
-------------------------------------------------

Headers:

- `X-API-Key` or `X-Business-ID` to resolve the tenant.

These routes are exposed under both a legacy prefix (`/telephony/*`) and a
versioned alias (`/v1/telephony/*`). New clients should prefer the `/v1`
paths; existing integrations can continue using `/telephony/*` unchanged.

Endpoints (paths shown with the legacy prefix):

- `POST /telephony/inbound`
  - Body: `{ "caller_phone": "...", "provider_call_id": "...", "lead_source": "..." }`
  - Response: `{ "session_id", "reply_text", "session_state", "audio" }`
  - Provider-agnostic entrypoint for new calls; triggers the greeting turn.

- `POST /telephony/audio`
  - Body: `{ "session_id": "...", "text": "...", "audio": "<base64>" }`
  - Response: `{ "reply_text", "session_state", "audio" }`
  - Additional turns for an active call. Tracks request/error metrics but does not currently derive
    per-tenant metrics from headers.

- `POST /telephony/end`
  - Body: `{ "session_id": "..." }`
  - Response: `{ "status": "ended:<session_id>" }`
  - Ends a telephony call and clears the in-memory session.

Twilio Webhooks (`/twilio/*`, `/v1/twilio/*`)
---------------------------------------------

Configured from the Twilio Console. Per-tenant routing can be:

- By query parameter: `?business_id=<tenant_id>`.
- Or by API key: add `X-API-Key` via a proxy in front of Twilio.

These webhooks are available both at `/twilio/*` and the versioned alias
`/v1/twilio/*`. The latter is preferred for new Twilio Console
configurations while keeping existing `/twilio/*` URLs valid.

Endpoints (paths shown with the legacy prefix):

- `POST /twilio/voice`
  - Form-encoded Twilio params (`From`, `To`, `CallSid`, `SpeechResult`, etc.).
  - Response: TwiML `<Response>...</Response>` that:
    - Uses `<Say>` for speech.
    - Uses `<Gather input="speech" action="/twilio/voice">` for subsequent turns.
  - Tracks `twilio_voice_requests` / `twilio_voice_errors` and per-tenant `twilio_by_business`.

- `POST /twilio/owner-voice`
  - Similar to `/twilio/voice` but for owner-facing voice summaries (schedule, todayâ€™s jobs).

- `POST /twilio/sms`
  - Form-encoded Twilio SMS payloads (`From`, `To`, `Body`, etc.).
  - Handles:
    - Customer SMS conversations via the same conversation manager.
    - Opt-out/opt-in keywords for customer SMS.
    - Confirmation, cancellation, and reschedule flows via simple keywords.
  - Response: TwiML `<Message>...</Message>`.
  - Tracks `twilio_sms_requests` / `twilio_sms_errors` and per-tenant metrics.


CRM API (`/v1/crm/*`)
---------------------

Headers:

- `X-API-Key` and `X-Owner-Token` (via dashboard), plus `X-Business-ID` if used.

Key endpoints:

- `POST /v1/crm/customers`
- `GET /v1/crm/customers`
- `GET /v1/crm/customers/{customer_id}`
- `GET /v1/crm/customers/search?q=...`

  - Basic customer CRUD and search by name/phone, scoped by tenant.

- `POST /v1/crm/appointments`
- `GET /v1/crm/appointments`
- `GET /v1/crm/appointments/{appointment_id}`
- `PATCH /v1/crm/appointments/{appointment_id}`
- `GET /v1/crm/customers/{customer_id}/appointments`

  - Appointment CRUD including status, emergency flag, estimated value, tags, and technician fields.

- `GET /v1/crm/customers/{customer_id}/timeline`
  - Interleaved timeline of appointments and conversations.

- `GET /v1/crm/conversations`
- `GET /v1/crm/conversations/{conversation_id}`
- `PATCH /v1/crm/conversations/{conversation_id}/qa`

  - Conversation QA views and updates (flags, tags, outcome, notes).


Public Signup (`/v1/public/*`)
------------------------------

These endpoints are designed for a simple self-service onboarding portal for new service businesses.
By default they are disabled; enable them by setting `ALLOW_SELF_SIGNUP=true` in the backend
environment.

- `POST /v1/public/signup`
  - No auth headers (guarded by environment flag).
  - Body:

    ```json
    {
      "business_name": "Example Plumbing",
      "vertical": "plumbing",
      "owner_phone": "+15555551234",
      "contact_name": "Jane Owner",
      "contact_email": "owner@example.com",
      "website_url": "https://exampleplumbing.com"
    }
    ```

  - Behavior:
    - Creates a new `Business` row with a generated `id`, `api_key`, and `widget_token`.
    - Uses defaults from `AppSettings` for vertical, language, and calendar ID.
  - Response:

    ```json
    {
      "business_id": "generated-id",
      "name": "Example Plumbing",
      "vertical": "plumbing",
      "api_key": "TENANT_API_KEY",
      "widget_token": "WIDGET_TOKEN",
      "status": "ACTIVE",
      "owner_phone": "+15555551234"
    }
    ```

  - Use the returned `api_key` and `widget_token` with:
    - `dashboard/index.html` (owner dashboard) and `dashboard/admin.html` (admin dashboard).
    - `widget/embed.js` and `widget/chat.html` (web chat widget).


Owner API (`/v1/owner/*`)
-------------------------

Headers:

- `X-API-Key` and `X-Owner-Token`, plus `X-Business-ID` if used.

Scheduling & summaries:

- `GET /v1/owner/schedule/tomorrow`
- `GET /v1/owner/schedule/tomorrow/audio`
- `GET /v1/owner/summary/today`
- `GET /v1/owner/summary/today/audio`
- `GET /v1/owner/workload/next?days=N`
- `GET /v1/owner/business`

Analytics & exports:

- `GET /v1/owner/service-mix?days=N`
- `GET /v1/owner/pipeline?days=N`
- `GET /v1/owner/customers/analytics?days=N`
- `GET /v1/owner/service-economics?days=N`
- `GET /v1/owner/neighborhoods?days=N`
- `GET /v1/owner/calendar/90d`
- `GET /v1/owner/time-to-book?days=N`
 - `GET /v1/owner/conversion-funnel?days=N`
 - `GET /v1/owner/data-completeness?days=N`
- `GET /v1/owner/followups?days=N`
- `GET /v1/owner/retention`
- `GET /v1/owner/export/service-mix.csv?days=N`
- `GET /v1/owner/export/conversations.csv?days=N`
 - `GET /v1/owner/calendar/report.pdf?day=YYYY-MM-DD`

Conversations & QA:

- `GET /v1/owner/conversations/recent`
- `GET /v1/owner/conversations/review`
- `GET /v1/owner/reschedules`
- `GET /v1/owner/callbacks`

Metrics:

- `GET /v1/owner/sms-metrics`
- `GET /v1/owner/twilio-metrics`

AI owner assistant:

  - `POST /v1/owner/assistant/query`
  - Headers: `X-API-Key`, `X-Owner-Token`.
  - Body: `{ "question": "How do I read the emergency jobs metric?" }`.
  - Response: `{ "answer": "...", "model": "gpt-4o-mini" }`.
    - Backed by the same OpenAI configuration used for speech when `SPEECH_PROVIDER=openai` and
      `OPENAI_API_KEY` are set; otherwise returns a simple "assistant not configured" message. The
      model is grounded in local documentation (README, DASHBOARD, API reference, data model,
      security and privacy policies, and runbook) and is intended to answer questions about the
      owner dashboard, metrics, data semantics, and operational policies.


Auth Integrations (`/auth/*`)
-----------------------------

These routes are stubs that sketch how OAuth-style integrations for LinkedIn, Gmail/Workspace,
Google Calendar, OpenAI, and Twilio plug into the onboarding flow. They **do not** perform real
OAuth exchanges; a production deployment should replace the placeholder URLs and token handling
with provider SDKs and a secure secret store.

- `GET /auth/{provider}/start?business_id=...`
  - Path param `provider`: one of `linkedin`, `gmail`, `gcalendar`, `openai`, `twilio`.
  - Query: `business_id` (tenant initiating the flow).
  - Response body:
    - `provider`: normalized provider name.
    - `authorization_url`: placeholder URL to redirect the owner to for OAuth consent.
    - `note`: explanation that this URL should be replaced with the real provider authorize URL
      and a signed `state` token encoding the business id (and CSRF nonce).
  - Intended usage:
    - Owner clicks "Connect {provider}" in onboarding.
    - Frontend calls this endpoint, then redirects the browser to `authorization_url`.

- `GET /auth/{provider}/callback?state=...&code=...`
  - Path param `provider`: as above.
  - Query:
    - `state`: opaque token that encodes the `business_id` (in this stub, the raw id).
    - `code`: OAuth authorization code (ignored in the stub implementation).
  - Behaviour (stub):
    - Looks up the `Business` row for the decoded `business_id`.
    - Marks the corresponding `integration_*_status` column as `"connected"` for the provider.
    - Returns JSON:
      - `provider`, `business_id`, `connected: true`, and `redirect_url` (e.g. `/dashboard/onboarding.html`).
  - In a real implementation:
    - Validate and decode `state` to recover `business_id` and prevent CSRF.
    - Exchange `code` for tokens using the provider SDKs.
    - Store tokens/refresh tokens in a secure secret store keyed by `business_id`.
    - Optionally redirect the browser to the onboarding page or owner dashboard.


Reminders & Retention (`/v1/reminders/*`, `/v1/retention/*`)
------------------------------------------------------------

Headers:

- `X-API-Key` (and optionally `X-Business-ID`) to select the tenant.

Endpoints:

- `POST /v1/reminders/send-upcoming?hours_ahead=24`
  - Scans for upcoming appointments within the configured window (overridable per-tenant via `default_reminder_hours`).
  - Sends SMS reminders to customers who have not opted out.

- `POST /v1/reminders/send-followups`
  - Sends follow-up SMS to recent leads with conversations but no booked appointments.
  - Updates global and per-tenant `lead_followups_sent` metrics.

- `POST /v1/retention/send-retention`
  - Sends simple retention campaigns to past customers whose last visit is at least `min_days_since_last_visit` days ago and who have no future appointment.
  - Updates `metrics.retention_by_business` by campaign type and per-tenant `retention_messages_sent`.


Widget API (`/v1/widget/*`)
---------------------------

Headers:

- `X-Widget-Token` (preferred) or `X-API-Key` for tenant resolution.

Endpoints (high level):

- `POST /v1/widget/session/start`
- `POST /v1/widget/session/{session_id}/input`
- `POST /v1/widget/session/{session_id}/end`

These mirror the voice session API but are tailored for web chat (`channel="web"`) and are used by
`widget/chat.html` and `widget/embed.js`.


Admin API (`/v1/admin/*`)
-------------------------

Headers:

- `X-Admin-API-Key` (required).

Key endpoints:

- `POST /v1/admin/businesses`
- `GET /v1/admin/businesses`
- `PATCH /v1/admin/businesses/{business_id}`
- `POST /v1/admin/businesses/{business_id}/rotate-key`
- `POST /v1/admin/businesses/{business_id}/rotate-widget-token`
- `POST /v1/admin/demo-tenants`

  - Tenant creation, configuration, key rotation, and demo seeding.

- `GET /v1/admin/businesses/usage`
- `GET /v1/admin/businesses/usage.csv`

  - Per-tenant usage, emergencies, SMS volume, and service mix.

- `GET /v1/admin/twilio/health`

  - High-level Twilio/webhook health view, based on `twilio_*` and `twilio_by_business` metrics.
